<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>LINE 回答フォーム起動</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- LIFF SDK 読み込み -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   sans-serif;
      text-align: center;
      padding: 40px 20px;
      background-color: #f5f5f5;
    }
    #container {
      max-width: 400px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 24px 16px 32px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    #msg {
      font-size: 14px;
      color: #555;
      margin-bottom: 8px;
      white-space: pre-line; /* \n を改行として表示 */
    }
  </style>
</head>
<body>
  <div id="container">
    <p id="msg">少々お待ちください…</p>
  </div>

  <script>
　　// ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    // ┃  ★ここだけ書き換えてください (設定エリア)        ┃
    // ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    // ★Googleフォームの「viewform」までのURL（? より前だけ）
    const FORM_URL =
      "https://docs.google.com/forms/d/e/1FAIpQLSee_-u4FSOTU6g_ObpJj7ijS51dWDLL0I0zCBmzuRM6rucO4Q/viewform";

    // ★User_ID用の entry 番号（事前入力リンクで取得した値）
    //   例：entry.123456789 のような形
    const ENTRY_ID = "entry.521129424";  // ←取得した entry 番号に書き換え
    
　　// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    // ✋ ！！これより下は触らないでください！！ ✋
    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    // ★LIFF ID（LINE Developers の LIFF設定画面に表示）
    const MY_LIFF_ID = "2008582229-JQxY2yD4";
   
    // メッセージ文言（必要ならここも編集）
    const MSG_INIT        = "LIFF を初期化しています…";
    const MSG_CHECK_LOGIN = "ログイン状態を確認しています…";
    const MSG_GET_PROFILE = "ユーザー情報を取得しています…";
    const MSG_BUILD_URL   = "回答フォームを開いています…";
    const MSG_NEED_LINE   = "このページは\nLINE のトークから\n開いてください。";
    const MSG_ERROR_PREFIX = "エラーが発生しました：\n";

    // ======================================
    //  画面メッセージ表示用ヘルパー
    // ======================================
    function setMsg(text) {
      const el = document.getElementById("msg");
      if (el) el.innerText = text;
    }

    // ======================================
    //  メイン処理
    // ======================================
    async function main() {
      try {
        // ----------------------------------
        // 1. LINEアプリ内から開かれているか確認
        //    （外部ブラウザで開かれた場合は案内だけ表示）
        // ----------------------------------
        if (!window.liff) {
          // LIFF SDK 自体が読み込めていない場合
          setMsg(MSG_ERROR_PREFIX + "LIFF SDK が読み込めませんでした。");
          return;
        }

        if (!liff.isInClient()) {
          // LINE アプリの外（Chrome等）から開かれた場合
          setMsg(MSG_NEED_LINE);
          return;
        }

        // ----------------------------------
        // 2. LIFF 初期化
        // ----------------------------------
        setMsg(MSG_INIT);

        await liff.init({
          liffId: MY_LIFF_ID,
          // 外部ブラウザ対策も一応ON（LINEアプリ内なら特に悪影響なし）
          withLoginOnExternalBrowser: true
        });

        // ----------------------------------
        // 3. ログイン状態確認 → 未ログインならログインへ飛ばす
        // ----------------------------------
        setMsg(MSG_CHECK_LOGIN);

        if (!liff.isLoggedIn()) {
          // ログインしていない場合は LINE ログイン画面へ
          liff.login();
          return;  // ログイン後にこのページが再読み込みされる
        }

        // ----------------------------------
        // 4. プロフィール取得（ここで userId を取る）
        // ----------------------------------
        setMsg(MSG_GET_PROFILE);

        const profile = await liff.getProfile();
        const userId = profile.userId;  // ★Googleフォームに渡すID

        // ----------------------------------
        // 5. Google フォームのURLを組み立てて即移動
        // ----------------------------------
        setMsg(MSG_BUILD_URL);

        // 例:
        // https://.../viewform?usp=pp_url&entry.XXXXXX=<userId>
        const finalUrl =
          `${FORM_URL}?usp=pp_url&${ENTRY_ID}=${encodeURIComponent(userId)}`;

        // ★ボタンを出さず、すぐフォームに遷移する
        //   LINEアプリ内ブラウザのタブがそのまま Googleフォームに切り替わる
        location.href = finalUrl;

      } catch (err) {
        // ======================================
        //  エラー処理（日本語メッセージ）
        // ======================================
        let detail = "";
        try {
          if (err && err.message) {
            detail = err.message;
          } else {
            detail = JSON.stringify(err);
          }
        } catch (e) {
          detail = String(err);
        }

        setMsg(MSG_ERROR_PREFIX + detail);
      }
    }

    // ページ読み込み完了後にメイン処理を実行
    window.addEventListener("load", main);
  </script>
</body>
</html>
